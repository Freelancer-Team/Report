# 项目部署报告

## 服务器部署
为了完整实现我们的项目，达到真正的freelancer服务，生成一个公众可以使用的app和web应用的目的，我们也将我们的项目部署到了服务器上。  
我们最初用账号在AWS云上申请了一个Ubuntu服务器，但由于该服务器属于免费服务，提供的空间以及计算资源太小，我们申请了一个EC2服务器。新的服务器存储空间大，计算资源也多。同时它自带了Docker等我们需要的软件，帮我们的后续部署工作提供了遍历，节省了许多时间。我们采用了老师以及助教的意见，对我们的代码进行了容器化，前端、后端以及数据库分别部署到了三个容器中。避免了系统环境不兼容以及未来可能存在的系统迁移带来的许多问题。  
通过后续的测试发现，服务器位于国外的亚马逊服务器数据传输缓慢，通过组内讨论决定使用国内的阿里云服务器，来减少项目在传输数据时的时间消耗，来提高项目运行速度。
## 代码容器化
### 容器简介
简单地说，一个容器包含了完整的运行时环境：除了应用程序本身之外，这个应用所需的全部依赖、类库、其他二进制文件、配置文件等，都统一被打入了一个称为容器镜像的包中。通过将应用程序本身，和其依赖容器化，操作系统发行版本和其他基础环境造成的差异，都被抽象掉了。
### 容器优点
#### 部署方便
容器封装了所有运行应用程序所必需的相关的细节，比如应用依赖以及操作系统，这就使得镜像从一个环境移植到另外一个环境更加灵活。
#### 部署安全
我们可以通过容器技术将开发环境和测试环境以及生产环境保持版本和依赖上的统一，保证代码在一个高度统一的环境上执行。而测试环境的统一，也同样能解决CI流程对环境的要求。
#### 容器隔离带来的安全性
一台宿主机上可以运行多个容器，但这些容器内的进程是相互隔离的，且无法相互感知。其中一个容器的升级或者出现故障，不会影响其他容器。
#### 相比虚拟机来说更加轻量级
虚拟机和容器的目的类似，都致力于对应用程序及其关联性进行隔离，从而构建起一套能够不依赖于具体环境而运行的应用单元。
### 容器缺点
#### 性能问题
不管是虚机还是容器，都是运用不同的技术，对应用本身进行了一定程度的封装和隔离，在降低应用和应用之间以及应用和环境之间的耦合性上做了很多努力，但是随机而来的，就会产生更多的网络连接转发以及数据交互，这在低并发系统上表现不会太明显，而且往往不会成为一个应用的瓶颈（可能会分散于不同的虚机或者服务器上），但是当同一虚机或者服务器下面的容器需要更高并发量支撑的时候，也就是并发问题成为应用瓶颈的时候，容器会将这个问题放大，所以，并不是所有的应用场景都是适用于容器技术的。
### 容器应用
在本次Freelancer项目中，我们将项目的前端、后端以及数据库分别用不同的容器包装，并将三个容器跑在同一个服务器分配的网络桥上，让三个容器通过IP互相访问，从而实现整个项目。
#### 数据库
由于本项目使用的是MongoDB数据库，我们从Dockerhub上pull了mongo镜像，并将其跑在了容器mymongo中，再进入容器内部进行操作，将数据导入容器。在这个过程中，进行了容器内部文件与服务器本机文件的映射，相当于将容器内部的数据进行了备份，避免了某些特殊情况下数据的丢失。
#### 后端
构建了一个Dockerfile，在java:8镜像的基础上，将本地产生的jar包导入容器，并设置了entrypoint，使容器运行时能直接将jar包直接跑起来。然后通过docker build命令生成了freelancer镜像，并跑在了容器backend中。
#### 前端
将本地前端项目build成一个web文件夹，然后在服务器上pull了一个nginx镜像，将web文件夹导入容器，用里面的文件替换nginx里的默认index.html，最后跑在mynginx镜像中，并将容器的80端口与服务器本机映射，让我们能通过服务器IP访问web应用。
### 容器部署遇到的问题
+ 小组成员有3个人都是Windows家庭版的电脑，无法通过正常方法安装Docker。通过各种搜索，网上存在一些比较特殊的方法，可以强行安装Docker，但是我们最终采取了比较方便的方法，决定直接在服务器上对代码进行容器化并运行。
+ 老师要求前端、后端以及数据库分别跑在三个不同的容器中，由于容器的隔离机制，每个容器都被分配了一个属于自身的虚拟IP，所以我们不能再使用locahost进行端对端之间的相互访问。我们一开始想到了用绝对IP地址访问，于是我们使用了服务器的地址。在这里，我们走入了一个误区，我们在跑容器的时候，并没有使用host网络，而是给每个容器分配了一个bridge网络的虚拟地址，使得容器与服务器本身分离开。通过与助教的探讨以及网上资料的搜索，我们使用了这个虚拟IP，最终成功实现了后端与数据库的连接。
+ 最后也是最难的一个问题，我们采用了flutter来编写前端，以实现跨平台的功能。Flutter最早是只实现了Android以及iOS的跨平台功能，flutter的web端跨平台版本发布更晚。更像react、vue等语言对于大家都比较熟悉，网上的部署实例也比较多。然而flutter的项目实例，尤其是flutter-web的项目实例更少。我们对于如何部署flutter也有非常多的疑问，也积极的与助教以及其他同学探讨，但大家都没有尝试过flutter部署，后来联想到其他语言可以用nginx镜像直接跑web包来启动前端。但是我们在进行尝试时，flutter编译生成web包时，出现了由于flutter配置问题导致生成不出web包。在后来查阅了大量文章后才成功编译出web包，进而成功将web端用容器部署到了服务器。
## 手机端（Android）apk安装、真机调试
网上存在着许多方法，我们采取了最传统也是最简单的方法。将后端和数据库部署到服务器后，用数据线将手机连接到电脑，flutter检测到手机设备连接成功后，就可以用flutter run直接将前端代码编译生成apk文件并导入手机安装，经过调试和优化，与电脑上的手机模拟器的项目效果一样，成功连接到了服务器，并实现了预计的功能。iOS端真机测试类似，这里不再赘述。
